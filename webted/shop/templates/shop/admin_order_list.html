{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>üì¶ Admin - Order List</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .order-card {
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
        <a href="{% url 'admin_dashboard' %}" class="btn btn-dark">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>

    <!-- ‚úÖ ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö -->
    <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
        <select id="orderFilter" class="form-select form-select-sm" style="max-width: 200px;">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="waiting_confirm">‚åõ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="approved">‚è≥ ‡∏£‡∏≠‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
            <option value="completed">üì¶ ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="rejected">‚ùó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option> <!-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </select>

        <input type="date" id="dateFilter" class="form-control form-control-sm" style="max-width: 200px;">
        <button id="clearFilters" class="btn btn-sm btn-outline-secondary">‡∏•‡πâ‡∏≤‡∏á</button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Order</th>
                    <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>  
                    <th>üí¨ ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>  
                    <th>‡∏™‡∏•‡∏¥‡∏õ</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr class="order-card"
                    data-status="{{ order.status }}"
                    data-pickup-date="{{ order.pickup_date|date:'Y-m-d' }}">
                    <td><strong>#{{ order.id }}</strong></td>
                    <td>
                        {% if order.user.full_name %}
                            <span class="text-primary fw-bold">{{ order.user.full_name }}</span>
                        {% else %}
                            <span class="text-muted">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠</span>
                        {% endif %}
                    </td>
                    <td>{{ order.created_at|date:"M d, Y, H:i A" }}</td>
                    <td>
                        <ul class="list-group list-group-flush">
                            {% for item in order.items.all %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ item.product.name }} 
                                    <span class="badge bg-primary">{{ item.quantity }} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>
                        {% if order.comment %}
                            <span class="text-muted">{{ order.comment }}</span>
                        {% else %}
                            <span class="text-secondary">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå -</span>
                        {% endif %}
                    </td>
                    <td><span class="fw-bold text-success">{{ order.total_price|floatformat:2 }} ‡∏ö‡∏≤‡∏ó</span></td>
                    <td>
                        {% if order.payment_slip %}
                            <a href="{{ order.payment_slip.url }}" target="_blank">
                                <img src="{{ order.payment_slip.url }}" class="img-fluid rounded" style="max-height: 60px;">
                            </a>
                        {% else %}
                            <span class="badge bg-danger">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.status == "waiting_confirm" %}
                            <span class="badge bg-warning">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                        {% elif order.status == "approved" %}
                            <span class="badge bg-info">‚è≥ ‡∏£‡∏≠‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                        {% elif order.status == "completed" %}
                            <span class="badge bg-primary">üì¶ ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                        {% elif order.status == "rejected" %}
                            <span class="badge bg-danger">‚ùó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span> <!-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                        {% endif %}
                    </td>
                    <td>
                        {% if order.status == "waiting_confirm" %}
                            <div class="d-flex flex-column gap-2">
                                <a href="{% url 'admin_confirm_payment' order.id %}" class="btn btn-sm btn-success">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</a>
                                <a href="{% url 'admin_reject_payment' order.id %}" class="btn btn-sm btn-danger">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</a>
                            </div>
                        {% elif order.status == "approved" %}
                            <div class="d-flex flex-column gap-2">
                                <a href="{% url 'mark_order_completed' order.id %}" class="btn btn-sm btn-primary">üì¶ ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</a>
                            </div>
                        {% endif %}        
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="pagination" class="d-flex justify-content-center my-3"></div> <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const pageSize = 10;
            const statusSelect = document.getElementById("orderFilter");
            const dateInput = document.getElementById("dateFilter");
            const clearBtn = document.getElementById("clearFilters");
            const allRows = Array.from(document.querySelectorAll("tbody tr.order-card"));
            const pagination = document.getElementById("pagination");

            let filteredRows = [...allRows];
            let currentPage = 1;

            function filterOrders() {
                const selectedStatus = statusSelect.value;
                const selectedDate = dateInput.value;

                filteredRows = allRows.filter(row => {
                    const status = row.getAttribute("data-status");
                    const pickup = row.getAttribute("data-pickup-date");

                    let show = true;

                    if (selectedStatus !== "all" && status !== selectedStatus) {
                        show = false;
                    }

                    if (selectedDate && pickup !== selectedDate) {
                        show = false;
                    }

                    return show;
                });

                currentPage = 1;
                showPage(currentPage);
            }

            function showPage(page) {
                const start = (page - 1) * pageSize;
                const end = page * pageSize;

                allRows.forEach(row => row.style.display = "none");
                filteredRows.slice(start, end).forEach(row => row.style.display = "");

                renderPagination(page);
            }

            function renderPagination(active) {
                const pageCount = Math.ceil(filteredRows.length / pageSize);
                pagination.innerHTML = "";

                if (pageCount <= 1) return;

                for (let i = 1; i <= pageCount; i++) {
                    const btn = document.createElement("button");
                    btn.className = "btn btn-sm mx-1 " + (i === active ? "btn-primary" : "btn-outline-primary");
                    btn.textContent = i;
                    btn.onclick = () => {
                        currentPage = i;
                        showPage(i);
                    };
                    pagination.appendChild(btn);
                }
            }

            statusSelect.addEventListener("change", filterOrders);
            dateInput.addEventListener("change", filterOrders);
            clearBtn.addEventListener("click", function () {
                statusSelect.value = "all";
                dateInput.value = "";
                filterOrders();
            });

            filterOrders();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
